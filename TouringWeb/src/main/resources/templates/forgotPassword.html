<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quên mật khẩu</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
<h1>Quên mật khẩu</h1>
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required><br><br>
    <button type="button" onclick="sendOTP()">Gửi OTP</button>
    <br><br>
    <div id="otp-section" style="display: none;">
        <label for="otp">Mã OTP:</label>
        <input type="text" id="otp" name="otp" required maxlength="6"><br><br>
        <button type="button" onclick="verifyOTP()">Xác nhận OTP</button>
    </div>
    <br><br>
    <div id="password-section" style="display: none;">
        <label for="new-password">Mật khẩu mới:</label>
        <input type="password" id="new-password" name="new-password" required><br><br>
        <label for="confirm-password">Xác nhận mật khẩu mới:</label>
        <input type="password" id="confirm-password" name="confirm-password" required><br><br>
        <button onclick="changePass()">Đổi mật khẩu</button>
    </div>

<script>
    // Lấy các phần tử HTML cần thiết
    const emailInput = document.getElementById("email");
    const otpSection = document.getElementById("otp-section");
    const otpInput = document.getElementById("otp");
    const passwordSection = document.getElementById("password-section");
    const newPasswordInput = document.getElementById("new-password");
    const confirmPasswordInput = document.getElementById("confirm-password");
    const submitBtn = document.querySelector("button[type=submit]");


    // Gửi mã OTP
    function sendOTP() {
        // Kiểm tra xem email có hợp lệ hay không
        var email = $("#email").val();
        if (!validateEmail(email)) {
            alert("Email không hợp lệ");
            return;
        }
        // send request to server to generate OTP and send it to user's email
        console.log("vào oke")
        $.ajax({
            url: "/forgotPassword?email="+email,
            type: "GET",
            success: function(response) {
                alert(response);
                // show OTP input section
                $("#otp-section").show();
            },
            error: function(error) {
                alert(error.responseText);
            }
        });

        // Gửi email để lấy mã OTP từ server
        // Nếu thành công, hiển thị phần nhập mã OTP và ẩn phần nhập email
        otpSection.style.display = "block";
        emailInput.disabled = true;
        otpInput.focus();
    }

    function verifyOTP() {
        var otp = $("#otp").val();

        if (!validateOTP(otp)) {
            alert("Mã OTP không hợp lệ");
            return;
        }
        if (otp ="") {
            alert("Vui lòng nhập otp");
            return;
        }
        var otp1 = $("#otp").val();
        var email = $("#email").val();

        // send request to server to verify OTP code
        $.ajax({
            url: "/forgotPassword/confirmOtp?email=" + email + "&otp=" + otp1,
            type: "GET",
            success: function(response) {
                if (response === "forgotPassword") {
                    // show password input section
                    $("#password-section").show();
                } else {
                    alert("Invalid OTP code");
                }
            },
            error: function(error) {
                alert(error.responseText);
            }
        });
    }

    // Kiểm tra xem email có hợp lệ hay không
    function validateEmail(email) {
        const re = /\S+@\S+\.\S+/;
        return re.test(email);
    }

    // Kiểm tra xem mã OTP có hợp lệ hay không
    function validateOTP(otp) {
        const re = /^\d{6}$/;
        return re.test(otp);
    }

    // Kiểm tra xem mật khẩu mới và xác nhận mật khẩu có giống nhau hay không
    function validatePassword() {
        if (newPasswordInput.value !== confirmPasswordInput.value) {
            alert("Mật khẩu mới và xác nhận mật khẩu không giống nhau");
            return false;
        }
        return true;
    }

    function changePass() {
        if (validatePassword()) {
            console.log("vào đổi mật khẩu")
            var email = $("#email").val();
            var newPass = $("#new-password").val();
            $.ajax({
                url: "/forgotPassword/changNewPass?email="+email+"&newPass="+newPass,
                type: "GET",
                success: function(response) {
                    if(response === "successfully"){
                        // Đổi mật khẩu thành công
                        alert("Đổi mật khẩu thành công");
                        window.location.href = "http://localhost:8080/";
                    }else {
                        alert("Đổi mật khẩu thất bại");
                    }

                },
                error: function(error) {
                    alert(error.responseText);
                }
            });
        }
    }
</script>
</body>
</html>
